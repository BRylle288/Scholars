<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documents - Cainta Scholarship Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .dashboard-header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
        }
        .nav-pills .nav-link.active {
            background-color: #2c3e50;
        }
        .nav-pills .nav-link {
            color: #2c3e50;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .profile-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .document-item {
            border-left: 3px solid transparent;
            transition: all 0.3s;
        }
        .document-item.required {
            border-left-color: #dc3545;
        }
        .document-item.optional {
            border-left-color: #ffc107;
        }
        .document-item.completed {
            border-left-color: #28a745;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #007bff;
            background-color: #e8f4ff;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background-color: #e8f4ff;
        }
        .file-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
        }
    </style>
    
    <!-- Firebase App (core SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1><i class="bi bi-book-half"></i> Documents</h1>
                    <p class="lead" id="welcomeMessage">Welcome, Scholar</p>
                </div>
                <div class="col-md-6 text-end">
                    <a href="scholar-dashboard.html" class="btn btn-light me-2">Dashboard</a>
                    <a href="#" id="logoutBtn" class="btn btn-light">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Content -->
    <div class="container mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <img src="https://ui-avatars.com/api/?name=Scholar&background=2c3e50&color=fff" class="profile-img rounded-circle mb-3" id="profileImage">
                        <h5 id="userName">Scholar Name</h5>
                        <p class="text-muted" id="userBarangay">Barangay</p>
                    </div>
                </div>
                
                <div class="list-group">
                    <a href="scholar-dashboard.html" class="list-group-item list-group-item-action">Dashboard</a>
                    <a href="scholar-profile.html" class="list-group-item list-group-item-action">My Profile</a>
                    <a href="scholar-application-status.html" class="list-group-item list-group-item-action">Application Status</a>
                    <a href="scholar-renew.html" class="list-group-item list-group-item-action">Renew Application</a>
                    <a href="scholar-documents.html" class="list-group-item list-group-item-action active">Documents</a>
                    <a href="scholar-messages.html" class="list-group-item list-group-item-action">Messages</a>
                    <a href="scholar-settings.html" class="list-group-item list-group-item-action">Settings</a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Required Documents</h5>
                        <span class="badge bg-success" id="documentsStatus">0/5 Submitted</span>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Please upload all required documents to complete your application. 
                            All documents must be clear and readable.
                        </div>
                        
                        <div class="list-group mb-4" id="documentsList">
                            <div class="list-group-item document-item required">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Grade Report (Previous Semester)</h6>
                                        <p class="mb-1 text-muted">Official transcript of grades from your previous semester</p>
                                        <small class="text-muted">Required file types: PDF, JPG, PNG (Max: 5MB)</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-danger me-2">Required</span>
                                        <button class="btn btn-outline-primary btn-sm" data-doc-type="gradeReport">
                                            <i class="bi bi-upload"></i> Upload
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item document-item required">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Registration Form (Current Semester)</h6>
                                        <p class="mb-1 text-muted">Official registration form for the current semester</p>
                                        <small class="text-muted">Required file types: PDF, JPG, PNG (Max: 5MB)</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-danger me-2">Required</span>
                                        <button class="btn btn-outline-primary btn-sm" data-doc-type="registrationForm">
                                            <i class="bi bi-upload"></i> Upload
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item document-item required">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Certificate of Enrollment</h6>
                                        <p class="mb-1 text-muted">Official certificate proving your current enrollment status</p>
                                        <small class="text-muted">Required file types: PDF, JPG, PNG (Max: 5MB)</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-danger me-2">Required</span>
                                        <button class="btn btn-outline-primary btn-sm" data-doc-type="enrollmentCert">
                                            <i class="bi bi-upload"></i> Upload
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item document-item required">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Barangay Certification</h6>
                                        <p class="mb-1 text-muted">Certification from your barangay proving residency</p>
                                        <small class="text-muted">Required file types: PDF, JPG, PNG (Max: 5MB)</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-danger me-2">Required</span>
                                        <button class="btn btn-outline-primary btn-sm" data-doc-type="barangayCert">
                                            <i class="bi bi-upload"></i> Upload
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item document-item required">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Valid ID</h6>
                                        <p class="mb-1 text-muted">Government-issued ID (e.g., School ID, Postal ID, etc.)</p>
                                        <small class="text-muted">Required file types: PDF, JPG, PNG (Max: 5MB)</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-danger me-2">Required</span>
                                        <button class="btn btn-outline-primary btn-sm" data-doc-type="validId">
                                            <i class="bi bi-upload"></i> Upload
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> Your application will not be processed until all required documents are submitted.
                        </div>
                    </div>
                </div>
                
                <!-- Uploaded Documents -->
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Uploaded Documents</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="uploadedDocumentsTable">
                                <thead>
                                    <tr>
                                        <th>Document Type</th>
                                        <th>File Name</th>
                                        <th>Upload Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <i class="bi bi-inbox display-4 text-muted"></i>
                                            <p class="mt-2">No documents uploaded yet</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalTitle">Upload Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                        <input type="hidden" id="docType">
                        <div class="mb-3">
                            <label for="documentFile" class="form-label">Select File</label>
                            <div class="upload-area" id="dropZone">
                                <i class="bi bi-cloud-upload display-4 text-muted"></i>
                                <p class="mt-2">Drag & drop your file here or click to browse</p>
                                <p class="small text-muted">Supported formats: PDF, JPG, PNG (Max: 5MB)</p>
                                <input type="file" class="d-none" id="documentFile" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                        </div>
                        <div class="mb-3" id="filePreviewContainer" style="display: none;">
                            <label class="form-label">File Preview</label>
                            <div class="text-center">
                                <img src="" class="file-preview mb-2" id="filePreview">
                                <p class="small mb-0" id="fileName"></p>
                                <p class="small text-muted" id="fileSize"></p>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="uploadButton" disabled>Upload Document</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDTXsOC825l5OXlfUxORKElHN0ofr5f-as",
            authDomain: "scholars-e7dc9.firebaseapp.com",
            databaseURL: "https://scholars-e7dc9-default-rtdb.firebaseio.com",
            projectId: "scholars-e7dc9",
            storageBucket: "scholars-e7dc9.firebasestorage.app",
            messagingSenderId: "213573709394",
            appId: "1:213573709394:web:185dbff8bcef1f2b6bb98b",
            measurementId: "G-X100VWE5NW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null;
        let currentDocType = null;
        let selectedFile = null;

        // Check if user is authenticated and is scholar
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                db.collection('users').doc(user.uid).get()
                    .then((doc) => {
                        if (doc.exists && doc.data().userType === 'scholar') {
                            // Load user data
                            const userData = doc.data();
                            document.getElementById('userName').textContent = userData.name || 'Scholar';
                            document.getElementById('welcomeMessage').textContent = `Welcome, ${userData.name || 'Scholar'}`;
                            document.getElementById('profileImage').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name || 'Scholar')}&background=2c3e50&color=fff`;
                            
                            // Load profile data for barangay
                            db.collection('profiles').doc(user.uid).get()
                                .then((profileDoc) => {
                                    if (profileDoc.exists) {
                                        document.getElementById('userBarangay').textContent = profileDoc.data().barangay || '';
                                    }
                                });
                                
                            // Load documents
                            loadDocuments(user.uid);
                        } else {
                            window.location.href = 'scholar-login.html';
                        }
                    })
                    .catch((error) => {
                        console.error("Error getting user document:", error);
                        window.location.href = 'scholar-login.html';
                    });
            } else {
                window.location.href = 'scholar-login.html';
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        });

        // Load documents from Firestore
        function loadDocuments(userId) {
            db.collection('documents')
                .where('userId', '==', userId)
                .orderBy('uploadedAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    const uploadedDocsTable = document.getElementById('uploadedDocumentsTable');
                    const tbody = uploadedDocsTable.querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    let submittedCount = 0;
                    
                    if (querySnapshot.empty) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <i class="bi bi-inbox display-4 text-muted"></i>
                                    <p class="mt-2">No documents uploaded yet</p>
                                </td>
                            </tr>
                        `;
                    } else {
                        querySnapshot.forEach((doc) => {
                            const documentData = doc.data();
                            submittedCount++;
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${getDocumentTypeName(documentData.docType)}</td>
                                <td>${documentData.fileName}</td>
                                <td>${documentData.uploadedAt ? documentData.uploadedAt.toDate().toLocaleDateString() : 'N/A'}</td>
                                <td><span class="badge bg-success">Uploaded</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary view-doc" data-url="${documentData.url}">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-doc" data-id="${doc.id}" data-type="${documentData.docType}">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        // Mark documents as completed in the list
                        querySnapshot.forEach((doc) => {
                            const documentData = doc.data();
                            const docItems = document.querySelectorAll(`[data-doc-type="${documentData.docType}"]`);
                            docItems.forEach(item => {
                                const listItem = item.closest('.document-item');
                                if (listItem) {
                                    listItem.classList.remove('required');
                                    listItem.classList.add('completed');
                                    const badge = listItem.querySelector('.badge');
                                    if (badge) {
                                        badge.className = 'badge bg-success me-2';
                                        badge.textContent = 'Uploaded';
                                    }
                                    const button = listItem.querySelector('button');
                                    if (button) {
                                        button.innerHTML = '<i class="bi bi-arrow-repeat"></i> Replace';
                                    }
                                }
                            });
                        });
                    }
                    
                    // Update documents status
                    document.getElementById('documentsStatus').textContent = `${submittedCount}/5 Submitted`;
                })
                .catch((error) => {
                    console.error("Error loading documents:", error);
                    showError('Error loading documents. Please try again later.');
                });
        }

        // Get document type name for display
        function getDocumentTypeName(docType) {
            const typeMap = {
                'gradeReport': 'Grade Report',
                'registrationForm': 'Registration Form',
                'enrollmentCert': 'Certificate of Enrollment',
                'barangayCert': 'Barangay Certification',
                'validId': 'Valid ID'
            };
            return typeMap[docType] || docType;
        }

        // Set up upload buttons
        document.querySelectorAll('[data-doc-type]').forEach(button => {
            button.addEventListener('click', () => {
                currentDocType = button.getAttribute('data-doc-type');
                const modalTitle = document.getElementById('uploadModalTitle');
                modalTitle.textContent = `Upload ${getDocumentTypeName(currentDocType)}`;
                document.getElementById('docType').value = currentDocType;
                
                // Reset form
                document.getElementById('filePreviewContainer').style.display = 'none';
                document.getElementById('uploadButton').disabled = true;
                document.getElementById('documentFile').value = '';
                
                // Show modal
                const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
                uploadModal.show();
            });
        });

        // Set up file input
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('documentFile');
        
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            if (e.dataTransfer.files.length) {
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFileSelect(fileInput.files[0]);
            }
        });
        
        function handleFileSelect(file) {
            // Check file type
            const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                showError('Invalid file type. Please upload PDF, JPG, or PNG files.');
                return;
            }
            
            // Check file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showError('File size too large. Maximum size is 5MB.');
                return;
            }
            
            selectedFile = file;
            
            // Show file preview for images
            if (file.type.includes('image')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('filePreview').src = e.target.result;
                    document.getElementById('filePreviewContainer').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('filePreviewContainer').style.display = 'block';
                document.getElementById('filePreview').src = 'https://cdn-icons-png.flaticon.com/512/337/337946.png';
            }
            
            // Update file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = `Size: ${formatFileSize(file.size)}`;
            
            // Enable upload button
            document.getElementById('uploadButton').disabled = false;
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        // Upload document
        document.getElementById('uploadButton').addEventListener('click', () => {
            if (!selectedFile || !currentDocType) return;
            
            const uploadButton = document.getElementById('uploadButton');
            uploadButton.disabled = true;
            uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
            
            // Create a storage reference
            const storageRef = storage.ref();
            const fileRef = storageRef.child(`documents/${currentUser.uid}/${currentDocType}/${selectedFile.name}`);
            
            // Upload file
            fileRef.put(selectedFile)
                .then((snapshot) => {
                    return snapshot.ref.getDownloadURL();
                })
                .then((downloadURL) => {
                    // Save document info to Firestore
                    return db.collection('documents').add({
                        userId: currentUser.uid,
                        docType: currentDocType,
                        fileName: selectedFile.name,
                        url: downloadURL,
                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'submitted'
                    });
                })
                .then(() => {
                    // Close modal and refresh documents list
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    loadDocuments(currentUser.uid);
                    showSuccess('Document uploaded successfully!');
                })
                .catch((error) => {
                    console.error("Error uploading document:", error);
                    uploadButton.disabled = false;
                    uploadButton.innerHTML = 'Upload Document';
                    showError('Error uploading document. Please try again.');
                });
        });
        
        // View document
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-doc') || e.target.closest('.view-doc')) {
                const button = e.target.classList.contains('view-doc') ? e.target : e.target.closest('.view-doc');
                const url = button.getAttribute('data-url');
                window.open(url, '_blank');
            }
        });
        
        // Delete document
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-doc') || e.target.closest('.delete-doc')) {
                const button = e.target.classList.contains('delete-doc') ? e.target : e.target.closest('.delete-doc');
                const docId = button.getAttribute('data-id');
                const docType = button.getAttribute('data-type');
                
                if (confirm('Are you sure you want to delete this document?')) {
                    db.collection('documents').doc(docId).delete()
                        .then(() => {
                            // Mark document as not uploaded in the list
                            const docItems = document.querySelectorAll(`[data-doc-type="${docType}"]`);
                            docItems.forEach(item => {
                                const listItem = item.closest('.document-item');
                                if (listItem) {
                                    listItem.classList.remove('completed');
                                    listItem.classList.add('required');
                                    const badge = listItem.querySelector('.badge');
                                    if (badge) {
                                        badge.className = 'badge bg-danger me-2';
                                        badge.textContent = 'Required';
                                    }
                                    const button = listItem.querySelector('button');
                                    if (button) {
                                        button.innerHTML = '<i class="bi bi-upload"></i> Upload';
                                    }
                                }
                            });
                            
                            loadDocuments(currentUser.uid);
                            showSuccess('Document deleted successfully!');
                        })
                        .catch((error) => {
                            console.error("Error deleting document:", error);
                            showError('Error deleting document. Please try again.');
                        });
                }
            }
        });

        function showError(message) {
            // Remove any existing alerts
            const existingAlerts = document.querySelectorAll('.alert.alert-danger');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.card-body').prepend(alertDiv);
        }
        
        function showSuccess(message) {
            // Remove any existing alerts
            const existingAlerts = document.querySelectorAll('.alert.alert-success');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle-fill"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.card-body').prepend(alertDiv);
        }
    </script>
</body>
</html>