<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholar Dashboard - Cainta Scholarship Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .dashboard-header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
        }
        .nav-pills .nav-link.active {
            background-color: #2c3e50;
        }
        .nav-pills .nav-link {
            color: #2c3e50;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-pending {
            background-color: #ffeeba;
            color: #856404;
        }
        .status-approved {
            background-color: #c3e6cb;
            color: #155724;
        }
        .status-rejected {
            background-color: #f5c6cb;
            color: #721c24;
        }
        .profile-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .progress {
            height: 20px;
        }
        .index-help {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
    </style>
    
    <!-- Firebase App (core SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1><i class="bi bi-book-half"></i> Scholar Dashboard</h1>
                    <p class="lead" id="welcomeMessage">Welcome, Scholar</p>
                </div>
                <div class="col-md-6 text-end">
                    <a href="#" id="logoutBtn" class="btn btn-light">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Content -->
    <div class="container mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <img src="https://ui-avatars.com/api/?name=Scholar&background=2c3e50&color=fff" class="profile-img rounded-circle mb-3" id="profileImage">
                        <h5 id="userName">Scholar Name</h5>
                        <p class="text-muted" id="userBarangay">Barangay</p>
                        <p><span class="status-badge status-approved" id="statusBadge">Approved Scholar</span></p>
                    </div>
                </div>
                
                <div class="list-group">
                    <a href="scholar-dashboard.html" class="list-group-item list-group-item-action active">Dashboard</a>
                    <a href="scholar-profile.html" class="list-group-item list-group-item-action">My Profile</a>
                    <a href="scholar-application-status.html" class="list-group-item list-group-item-action">Application Status</a>
                    <a href="scholar-renew.html" class="list-group-item list-group-item-action">Renew Application</a>
                    <a href="scholar-settings.html" class="list-group-item list-group-item-action">Settings</a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9">
                <!-- Index Help Alert (initially hidden) -->
                <div class="alert index-help mb-4" id="indexHelp" style="display: none;">
                    <h5><i class="bi bi-exclamation-triangle"></i> Database Configuration Needed</h5>
                    <p>Your scholarship portal needs a quick database configuration. Please ask your administrator to:</p>
                    <ol>
                        <li>Go to the Firebase Console</li>
                        <li>Open your project</li>
                        <li>Navigate to Firestore Database â†’ Indexes</li>
                        <li>Create a composite index with:
                            <ul>
                                <li>Collection: <code>applications</code></li>
                                <li>Field 1: <code>userId</code> (Ascending)</li>
                                <li>Field 2: <code>createdAt</code> (Descending)</li>
                            </ul>
                        </li>
                    </ol>
                    <p class="mb-0">This is a one-time setup. The application will work normally after the index is created.</p>
                </div>
                
                <!-- Application Status -->
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Application Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success" id="statusAlert">
                            <i class="bi bi-check-circle-fill"></i> Your scholarship application has been approved.
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">Complete</div>
                        </div>
                        <div class="row text-center">
                            <div class="col">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <p>Application Submitted</p>
                                <small id="submittedDate"></small>
                            </div>
                            <div class="col">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <p>Under Review</p>
                                <small id="reviewDate"></small>
                            </div>
                            <div class="col">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <p>Approved</p>
                                <small id="approvedDate"></small>
                            </div>
                            <div class="col">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <p>Grant Released</p>
                                <small id="releasedDate"></small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-pencil-square display-4 text-primary mb-3"></i>
                                <h5>Renew Application</h5>
                                <p class="card-text">Apply for scholarship renewal for the next school year.</p>
                                <a href="scholar-renew.html" class="btn btn-primary">Renew Now</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-file-text display-4 text-primary mb-3"></i>
                                <h5>Apply Scholarship</h5>
                                <p class="card-text">Submit required documents for your application.</p>
                                <a href="application-form.html" class="btn btn-primary">Upload</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-question-circle display-4 text-primary mb-3"></i>
                                <h5>Get Help</h5>
                                <p class="card-text">Contact support if you have any questions.</p>
                                <a href="scholar-messages.html" class="btn btn-primary">Contact</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Documents -->
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Required Documents</h5>
                        <span class="badge bg-success" id="documentsStatus"> Submitted</span>
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="documentsList">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                Grade Report (Previous Semester)
                                <i class="bi bi-check-circle-fill text-success"></i>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                Registration Form (Current Semester)
                                <i class="bi bi-check-circle-fill text-success"></i>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                Certificate of Enrollment
                                <i class="bi bi-check-circle-fill text-success"></i>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                Barangay Certification
                                <i class="bi bi-check-circle-fill text-success"></i>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                Valid ID
                                <i class="bi bi-check-circle-fill text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDTXsOC825l5OXlfUxORKElHN0ofr5f-as",
            authDomain: "scholars-e7dc9.firebaseapp.com",
            databaseURL: "https://scholars-e7dc9-default-rtdb.firebaseio.com",
            projectId: "scholars-e7dc9",
            storageBucket: "scholars-e7dc9.firebasestorage.app",
            messagingSenderId: "213573709394",
            appId: "1:213573709394:web:185dbff8bcef1f2b6bb98b",
            measurementId: "G-X100VWE5NW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userApplication = null;

        // Check if user is authenticated and is scholar
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                db.collection('users').doc(user.uid).get()
                    .then((doc) => {
                        if (doc.exists && doc.data().userType === 'scholar') {
                            // Load user data
                            const userData = doc.data();
                            document.getElementById('userName').textContent = userData.name || 'Scholar';
                            document.getElementById('welcomeMessage').textContent = `Welcome, ${userData.name || 'Scholar'}`;
                            document.getElementById('profileImage').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name || 'Scholar')}&background=2c3e50&color=fff`;
                            
                            // Load user's application
                            loadApplication(user.uid);
                        } else {
                            window.location.href = 'scholar-login.html';
                        }
                    })
                    .catch((error) => {
                        console.error("Error getting user document:", error);
                        window.location.href = 'scholar-login.html';
                    });
            } else {
                window.location.href = 'scholar-login.html';
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        });

        // Load application from Firestore
        function loadApplication(userId) {
            db.collection('applications')
                .where('userId', '==', userId)
                .orderBy('createdAt', 'desc')
                .limit(1)
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        querySnapshot.forEach((doc) => {
                            userApplication = { id: doc.id, ...doc.data() };
                            updateUIWithApplicationData(userApplication);
                        });
                    } else {
                        // No application found
                        document.getElementById('statusAlert').className = 'alert alert-info';
                        document.getElementById('statusAlert').innerHTML = '<i class="bi bi-info-circle-fill"></i> You haven\'t submitted an application yet.';
                        document.querySelector('.progress-bar').style.width = '0%';
                        document.querySelector('.progress-bar').textContent = 'Not Started';
                        document.getElementById('statusBadge').className = 'status-badge status-pending';
                        document.getElementById('statusBadge').textContent = 'No Application';
                    }
                })
                .catch((error) => {
                    console.error("Error getting application:", error);
                    
                    // Check if it's an index error
                    if (error.code === 'failed-precondition') {
                        // Show index help message
                        document.getElementById('indexHelp').style.display = 'block';
                        showError('Database index is being prepared. Some features may not work correctly.');
                        
                        // Fallback: Try to get applications without ordering
                        db.collection('applications')
                            .where('userId', '==', userId)
                            .get()
                            .then((querySnapshot) => {
                                if (!querySnapshot.empty) {
                                    // Find the most recent application manually
                                    let latestApp = null;
                                    querySnapshot.forEach((doc) => {
                                        const appData = doc.data();
                                        if (!latestApp || 
                                            (appData.createdAt && latestApp.createdAt && 
                                            appData.createdAt.toDate() > latestApp.createdAt.toDate())) {
                                            latestApp = { id: doc.id, ...appData };
                                        }
                                    });
                                    
                                    if (latestApp) {
                                        userApplication = latestApp;
                                        updateUIWithApplicationData(userApplication);
                                    }
                                }
                            });
                    } else {
                        showError('Error loading your application. Please try again later.');
                    }
                });
        }

        // Update UI with application data
        function updateUIWithApplicationData(application) {
            // Update status badge
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = application.status;
            statusBadge.className = `status-badge status-${application.status}`;
            
            // Update status alert
            const statusAlert = document.getElementById('statusAlert');
            if (application.status === 'pending') {
                statusAlert.className = 'alert alert-warning';
                statusAlert.innerHTML = '<i class="bi bi-clock-fill"></i> Your scholarship application is under review.';
            } else if (application.status === 'approved') {
                statusAlert.className = 'alert alert-success';
                statusAlert.innerHTML = '<i class="bi bi-check-circle-fill"></i> Your scholarship application has been approved.';
            } else if (application.status === 'rejected') {
                statusAlert.className = 'alert alert-danger';
                statusAlert.innerHTML = '<i class="bi bi-x-circle-fill"></i> Your scholarship application has been rejected.';
            }
            
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            if (application.status === 'pending') {
                progressBar.style.width = '50%';
                progressBar.textContent = 'Under Review';
                progressBar.className = 'progress-bar bg-warning';
            } else if (application.status === 'approved') {
                progressBar.style.width = '100%';
                progressBar.textContent = 'Approved';
                progressBar.className = 'progress-bar bg-success';
            } else if (application.status === 'rejected') {
                progressBar.style.width = '100%';
                progressBar.textContent = 'Rejected';
                progressBar.className = 'progress-bar bg-danger';
            }
            
            // Update dates
            if (application.createdAt) {
                document.getElementById('submittedDate').textContent = application.createdAt.toDate().toLocaleDateString();
            }
            
            // For demo purposes, set other dates based on submission date
            if (application.createdAt) {
                const submittedDate = application.createdAt.toDate();
                document.getElementById('reviewDate').textContent = new Date(submittedDate.getTime() + 5 * 24 * 60 * 60 * 1000).toLocaleDateString();
                
                if (application.status === 'approved' || application.status === 'rejected') {
                    document.getElementById('approvedDate').textContent = new Date(submittedDate.getTime() + 10 * 24 * 60 * 60 * 1000).toLocaleDateString();
                }
            }
            
            // Update barangay
            if (application.barangay) {
                document.getElementById('userBarangay').textContent = application.barangay;
            }
            
            // Update documents status (for demo, all are submitted if application exists)
            if (application.status === 'approved') {
                document.getElementById('documentsStatus').textContent = '5/5 Submitted';
            } else {
                document.getElementById('documentsStatus').textContent = '0/5 Submitted';
                const documentsList = document.getElementById('documentsList');
                documentsList.innerHTML = '';
                const documents = [
                    'Grade Report (Previous Semester)',
                    'Registration Form (Current Semester)',
                    'Certificate of Enrollment',
                    'Barangay Certification',
                    'Valid ID'
                ];
                
                documents.forEach(doc => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        ${doc}
                        <i class="bi bi-x-circle-fill text-danger"></i>
                    `;
                    documentsList.appendChild(item);
                });
            }
        }

        function showError(message) {
            // Create error alert if it doesn't exist
            let errorAlert = document.getElementById('errorAlert');
            if (!errorAlert) {
                errorAlert = document.createElement('div');
                errorAlert.id = 'errorAlert';
                errorAlert.className = 'alert alert-danger alert-dismissible fade show';
                errorAlert.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.col-md-9').prepend(errorAlert);
            } else {
                errorAlert.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                errorAlert.style.display = 'block';
            }
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>