<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Form - Cainta Scholarship Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .application-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #2c3e50;
            border-color: #2c3e50;
        }
        .btn-primary:hover {
            background-color: #1a252f;
            border-color: #1a252f;
        }
        .step-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        .step-progress::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #dee2e6;
            z-index: 1;
        }
        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            width: 40px;
            height: 40px;
            line-height: 40px;
            border-radius: 50%;
            background-color: #dee2e6;
            color: #6c757d;
            font-weight: bold;
        }
        .step.active {
            background-color: #2c3e50;
            color: white;
        }
        .step.completed {
            background-color: #28a745;
            color: white;
        }
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
        }
        .alert {
            display: none;
        }
        .google-form-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4285f4;
        }
        .instruction-list {
            padding-left: 20px;
        }
        .instruction-list li {
            margin-bottom: 10px;
        }
        .appointment-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .appointment-slot {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .appointment-slot:hover {
            background-color: #f8f9fa;
        }
        .appointment-slot.selected {
            background-color: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }
        .appointment-slot.unavailable {
            background-color: #f8d7da;
            color: #721c24;
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
    
    <!-- Firebase App (core SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="application-container">
            <div class="logo">
                <h2><i class="bi bi-book-half"></i> Scholarship Application</h2>
                <p class="text-muted">Cainta Scholarship Program</p>
            </div>
            
            <div id="errorAlert" class="alert alert-danger" role="alert"></div>
            <div id="successAlert" class="alert alert-success" role="alert"></div>
            
            <!-- Progress Steps -->
            <div class="step-progress">
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
                <div class="step" id="step3">3</div>
                <div class="step" id="step4">4</div>
                <div class="step" id="step5">5</div>
            </div>
            
            <!-- Step 1: Personal Information -->
            <div class="step-content active" id="step1-content">
                <h4 class="mb-4">Personal Information</h4>
                <form id="personalInfoForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phone" required>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Complete Address</label>
                        <textarea class="form-control" id="address" rows="2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="barangay" class="form-label">Barangay</label>
                        <select class="form-select" id="barangay" required>
                            <option value="">Select Barangay</option>
                            <option value="San Andres">San Andres</option>
                            <option value="Sta. Rosa">Sta. Rosa</option>
                            <option value="San Juan">San Juan</option>
                            <option value="San Isidro">San Isidro</option>
                            <option value="San Roque">San Roque</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-primary" id="nextToStep2">Next</button>
                    </div>
                </form>
            </div>
            
            <!-- Step 2: Educational Background -->
            <div class="step-content" id="step2-content">
                <h4 class="mb-4">Educational Background</h4>
                <form id="educationForm">
                    <div class="mb-3">
                        <label for="school" class="form-label">School Name</label>
                        <input type="text" class="form-control" id="school" required>
                    </div>
                    <div class="mb-3">
                        <label for="educationLevel" class="form-label">Education Level</label>
                        <select class="form-select" id="educationLevel" required>
                            <option value="">Select Level</option>
                            <option value="Senior High School">Senior High School</option>
                            <option value="College">College</option>
                            <option value="Technical/Vocational">Technical/Vocational</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="course" class="form-label">Course/Strand</label>
                        <input type="text" class="form-control" id="course" required>
                    </div>
                    <div class="mb-3">
                        <label for="yearLevel" class="form-label">Year Level</label>
                        <select class="form-select" id="yearLevel" required>
                            <option value="">Select Year Level</option>
                            <option value="Grade 11">Grade 11</option>
                            <option value="Grade 12">Grade 12</option>
                            <option value="1st Year">1st Year</option>
                            <option value="2nd Year">2nd Year</option>
                            <option value="3rd Year">3rd Year</option>
                            <option value="4th Year">4th Year</option>
                            <option value="5th Year">5th Year</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="gpa" class="form-label">GPA (General Weighted Average)</label>
                        <input type="number" step="0.01" min="1" max="5" class="form-control" id="gpa" required>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="backToStep1">Back</button>
                        <button type="button" class="btn btn-primary" id="nextToStep3">Next</button>
                    </div>
                </form>
            </div>
            
            <!-- Step 3: Appointment Scheduling -->
            <div class="step-content" id="step3-content">
                <h4 class="mb-4">Schedule Face-to-Face Exam</h4>
                <p class="text-muted mb-4">Please select an available time slot for your face-to-face examination.</p>
                
                <div class="mb-4">
                    <label for="appointmentDate" class="form-label">Select Date</label>
                    <input type="date" class="form-control" id="appointmentDate" required min="">
                </div>
                
                <div class="mb-4">
                    <label class="form-label">Available Time Slots</label>
                    <div class="appointment-slots" id="timeSlotsContainer">
                        <!-- Time slots will be dynamically generated -->
                    </div>
                    <div id="noSlotsMessage" class="alert alert-info mt-3" style="display: none;">
                        No available time slots for the selected date. Please choose another date.
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" id="backToStep2">Back</button>
                    <button type="button" class="btn btn-primary" id="nextToStep4">Next</button>
                </div>
            </div>
            
            <!-- Step 4: Google Form Submission -->
            <div class="step-content" id="step4-content">
                <h4 class="mb-4">Additional Information Form</h4>
                <div class="google-form-container">
                    <h5><i class="bi bi-google"></i> Complete the Google Form</h5>
                    <p>Please complete the following Google Form to provide additional information required for your scholarship application.</p>
                    
                    <ol class="instruction-list">
                        <li>Click the button below to open the Google Form in a new tab</li>
                        <li>Fill out all required fields in the form</li>
                        <li>Submit the form</li>
                        <li>Take a screenshot of the confirmation page after submission</li>
                        <li>Return to this page and upload the screenshot below</li>
                    </ol>
                    
                    <div class="d-grid gap-2">
                        <a href="https://docs.google.com/forms/d/e/1FAIpQLScaBxg3i74VsWDPC_JYIjpCqcHOc5CRYCKPNMqLRXvzn9cHHw/viewform" 
                           target="_blank" class="btn btn-primary">
                            <i class="bi bi-box-arrow-up-right"></i> Open Google Form
                        </a>
                    </div>
                </div>
                
                <form id="documentsForm">
                    <div class="mb-3">
                        <label for="googleFormScreenshot" class="form-label">Upload Screenshot of Submitted Google Form *</label>
                        <input type="file" class="form-control" id="googleFormScreenshot" accept=".pdf,.jpg,.jpeg,.png" required>
                        <div class="form-text">Please upload a screenshot showing you've successfully submitted the Google Form</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="backToStep3">Back</button>
                        <button type="button" class="btn btn-primary" id="nextToStep5">Next</button>
                    </div>
                </form>
            </div>
            
            <!-- Step 5: Review and Submit -->
            <div class="step-content" id="step5-content">
                <h4 class="mb-4">Review Your Application</h4>
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5>Personal Information</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Name:</strong> <span id="reviewName"></span></p>
                        <p><strong>Email:</strong> <span id="reviewEmail"></span></p>
                        <p><strong>Phone:</strong> <span id="reviewPhone"></span></p>
                        <p><strong>Address:</strong> <span id="reviewAddress"></span></p>
                        <p><strong>Barangay:</strong> <span id="reviewBarangay"></span></p>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5>Educational Background</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>School:</strong> <span id="reviewSchool"></span></p>
                        <p><strong>Education Level:</strong> <span id="reviewEducationLevel"></span></p>
                        <p><strong>Course/Strand:</strong> <span id="reviewCourse"></span></p>
                        <p><strong>Year Level:</strong> <span id="reviewYearLevel"></span></p>
                        <p><strong>GPA:</strong> <span id="reviewGpa"></span></p>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5>Exam Appointment</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Exam Date:</strong> <span id="reviewAppointmentDate"></span></p>
                        <p><strong>Exam Time:</strong> <span id="reviewAppointmentTime"></span></p>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5>Documents & Google Form</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Google Form Screenshot:</strong> <span id="reviewGoogleFormScreenshot">Provided</span></p>
                        <p>Other required documents have been selected for upload.</p>
                    </div>
                </div>
                
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                    <label class="form-check-label" for="agreeTerms">
                        I certify that the information provided is true and correct to the best of my knowledge.
                    </label>
                </div>
                
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" id="backToStep4">Back</button>
                    <button type="button" class="btn btn-primary" id="submitApplication">Submit Application</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDTXsOC825l5OXlfUxORKElHN0ofr5f-as",
        authDomain: "scholars-e7dc9.firebaseapp.com",
        databaseURL: "https://scholars-e7dc9-default-rtdb.firebaseio.com",
        projectId: "scholars-e7dc9",
        storageBucket: "scholars-e7dc9.firebasestorage.app",
        messagingSenderId: "213573709394",
        appId: "1:213573709394:web:185dbff8bcef1f2b6bb98b",
        measurementId: "G-X100VWE5NW"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let applicationData = {};

    // Check if user is authenticated and is scholar
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            db.collection('users').doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists && doc.data().userType === 'scholar') {
                        // Pre-fill email if available
                        document.getElementById('email').value = user.email || '';
                        
                        // Check if user already has an application
                        checkExistingApplication(user.uid);
                        
                        // Set minimum date for appointment (tomorrow)
                        const tomorrow = new Date();
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        const minDate = tomorrow.toISOString().split('T')[0];
                        document.getElementById('appointmentDate').min = minDate;
                    } else {
                        window.location.href = 'scholar-login.html';
                    }
                })
                .catch((error) => {
                    console.error("Error getting user document:", error);
                    window.location.href = 'scholar-login.html';
                });
        } else {
            window.location.href = 'scholar-login.html';
        }
    });

    // Check if user already has an application
    function checkExistingApplication(userId) {
        db.collection('applications').where('userId', '==', userId).get()
            .then((querySnapshot) => {
                if (!querySnapshot.empty) {
                    showError('You have already submitted an application.');
                    setTimeout(() => {
                        window.location.href = 'scholar-dashboard.html';
                    }, 2000);
                }
            })
            .catch((error) => {
                console.error("Error checking existing application:", error);
            });
    }

    // Step navigation
    document.getElementById('nextToStep2').addEventListener('click', () => {
        if (validateStep1()) {
            saveStep1Data();
            goToStep(2);
        }
    });

    document.getElementById('backToStep1').addEventListener('click', () => {
        goToStep(1);
    });

    document.getElementById('nextToStep3').addEventListener('click', () => {
        if (validateStep2()) {
            saveStep2Data();
            goToStep(3);
        }
    });

    document.getElementById('backToStep2').addEventListener('click', () => {
        goToStep(2);
    });

    document.getElementById('nextToStep4').addEventListener('click', () => {
        if (validateStep3()) {
            saveStep3Data();
            goToStep(4);
        }
    });

    document.getElementById('backToStep3').addEventListener('click', () => {
        goToStep(3);
    });

    document.getElementById('nextToStep5').addEventListener('click', () => {
        if (validateStep4()) {
            saveStep4Data();
            updateReviewSection();
            goToStep(5);
        }
    });

    document.getElementById('backToStep4').addEventListener('click', () => {
        goToStep(4);
    });

    document.getElementById('submitApplication').addEventListener('click', () => {
        if (document.getElementById('agreeTerms').checked) {
            submitApplication();
        } else {
            showError('Please agree to the terms before submitting.');
        }
    });

    // Appointment date change handler
    document.getElementById('appointmentDate').addEventListener('change', function() {
        loadAvailableTimeSlots(this.value);
    });

    // Load available time slots for selected date
    function loadAvailableTimeSlots(date) {
        const timeSlotsContainer = document.getElementById('timeSlotsContainer');
        const noSlotsMessage = document.getElementById('noSlotsMessage');
        
        // Clear previous slots
        timeSlotsContainer.innerHTML = '';
        
        // Define available time slots
        const allTimeSlots = [
            '09:00 AM', '10:00 AM', '11:00 AM', 
            '01:00 PM', '02:00 PM', '03:00 PM', '04:00 PM'
        ];
        
        // Check which slots are already booked (in a real app, this would query the database)
        // For demo purposes, we'll randomly mark some slots as unavailable
        const availableSlots = allTimeSlots.filter(slot => {
            return Math.random() > 0.3; // 70% chance of being available
        });
        
        if (availableSlots.length === 0) {
            noSlotsMessage.style.display = 'block';
            return;
        }
        
        noSlotsMessage.style.display = 'none';
        
        // Create slot buttons
        availableSlots.forEach(slot => {
            const slotElement = document.createElement('div');
            slotElement.className = 'appointment-slot';
            slotElement.textContent = slot;
            slotElement.setAttribute('data-time', slot);
            
            slotElement.addEventListener('click', function() {
                // Deselect all other slots
                document.querySelectorAll('.appointment-slot').forEach(s => {
                    s.classList.remove('selected');
                });
                
                // Select this slot
                this.classList.add('selected');
                applicationData.appointmentTime = this.getAttribute('data-time');
            });
            
            timeSlotsContainer.appendChild(slotElement);
        });
    }

    // Validate step 1
    function validateStep1() {
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const address = document.getElementById('address').value;
        const barangay = document.getElementById('barangay').value;
        
        if (!firstName || !lastName || !email || !phone || !address || !barangay) {
            showError('Please fill in all required fields.');
            return false;
        }
        
        if (!isValidEmail(email)) {
            showError('Please enter a valid email address.');
            return false;
        }
        
        hideAlerts();
        return true;
    }

    // Validate step 2
    function validateStep2() {
        const school = document.getElementById('school').value;
        const educationLevel = document.getElementById('educationLevel').value;
        const course = document.getElementById('course').value;
        const yearLevel = document.getElementById('yearLevel').value;
        const gpa = document.getElementById('gpa').value;
        
        if (!school || !educationLevel || !course || !yearLevel || !gpa) {
            showError('Please fill in all required fields.');
            return false;
        }
        
        if (gpa < 1 || gpa > 5) {
            showError('GPA must be between 1.00 and 5.00.');
            return false;
        }
        
        hideAlerts();
        return true;
    }

    // Validate step 3 (appointment)
    function validateStep3() {
        const appointmentDate = document.getElementById('appointmentDate').value;
        const selectedSlot = document.querySelector('.appointment-slot.selected');
        
        if (!appointmentDate) {
            showError('Please select an appointment date.');
            return false;
        }
        
        if (!selectedSlot) {
            showError('Please select an appointment time slot.');
            return false;
        }
        
        hideAlerts();
        return true;
    }

    // Validate step 4 (documents)
    function validateStep4() {
        // Check if Google Form screenshot is provided
        const googleFormScreenshot = document.getElementById('googleFormScreenshot').files.length;
        
        if (googleFormScreenshot === 0) {
            showError('Please upload a screenshot of your submitted Google Form.');
            return false;
        }
        
        hideAlerts();
        return true;
    }

    // Save step 1 data
    function saveStep1Data() {
        applicationData.firstName = document.getElementById('firstName').value;
        applicationData.lastName = document.getElementById('lastName').value;
        applicationData.email = document.getElementById('email').value;
        applicationData.phone = document.getElementById('phone').value;
        applicationData.address = document.getElementById('address').value;
        applicationData.barangay = document.getElementById('barangay').value;
        applicationData.fullName = `${applicationData.firstName} ${applicationData.lastName}`;
    }

    // Save step 2 data
    function saveStep2Data() {
        applicationData.school = document.getElementById('school').value;
        applicationData.educationLevel = document.getElementById('educationLevel').value;
        applicationData.course = document.getElementById('course').value;
        applicationData.yearLevel = document.getElementById('yearLevel').value;
        applicationData.gpa = document.getElementById('gpa').value;
    }

    // Save step 3 data (appointment)
    function saveStep3Data() {
        applicationData.appointmentDate = document.getElementById('appointmentDate').value;
        // appointmentTime is set when the user clicks on a time slot
    }

    // Save step 4 data
    function saveStep4Data() {
        // Store file names
        applicationData.documents = [];
        
        // Google Form screenshot is required
        if (document.getElementById('googleFormScreenshot').files.length > 0) {
            applicationData.documents.push('Google Form Screenshot');
        }
    }

    // Update review section
    function updateReviewSection() {
        document.getElementById('reviewName').textContent = applicationData.fullName;
        document.getElementById('reviewEmail').textContent = applicationData.email;
        document.getElementById('reviewPhone').textContent = applicationData.phone;
        document.getElementById('reviewAddress').textContent = applicationData.address;
        document.getElementById('reviewBarangay').textContent = applicationData.barangay;
        document.getElementById('reviewSchool').textContent = applicationData.school;
        document.getElementById('reviewEducationLevel').textContent = applicationData.educationLevel;
        document.getElementById('reviewCourse').textContent = applicationData.course;
        document.getElementById('reviewYearLevel').textContent = applicationData.yearLevel;
        document.getElementById('reviewGpa').textContent = applicationData.gpa;
        
        // Format and display appointment date
        if (applicationData.appointmentDate) {
            const dateObj = new Date(applicationData.appointmentDate);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('reviewAppointmentDate').textContent = formattedDate;
        }
        
        document.getElementById('reviewAppointmentTime').textContent = applicationData.appointmentTime || 'Not selected';
    }

    // Submit application to Firestore
    function submitApplication() {
        hideAlerts();
        
        // Add user ID and timestamp
        applicationData.userId = currentUser.uid;
        applicationData.status = 'pending';
        applicationData.examResult = 'pending'; // New field for exam result
        applicationData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        
        db.collection('applications').add(applicationData)
            .then((docRef) => {
                showSuccess('Application submitted successfully! Redirecting to dashboard...');
                setTimeout(() => {
                    window.location.href = 'scholar-dashboard.html';
                }, 2000);
            })
            .catch((error) => {
                console.error("Error adding application:", error);
                showError('Error submitting application. Please try again.');
            });
    }

    // Navigate to step
    function goToStep(stepNumber) {
        // Hide all steps
        document.querySelectorAll('.step-content').forEach(step => {
            step.classList.remove('active');
        });
        
        // Show current step
        document.getElementById(`step${stepNumber}-content`).classList.add('active');
        
        // Update progress indicators
        document.querySelectorAll('.step').forEach((step, index) => {
            if (index + 1 < stepNumber) {
                step.className = 'step completed';
            } else if (index + 1 === stepNumber) {
                step.className = 'step active';
            } else {
                step.className = 'step';
            }
        });
    }

    // Utility functions
    function isValidEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    function showError(message) {
        const alert = document.getElementById('errorAlert');
        alert.textContent = message;
        alert.style.display = 'block';
    }

    function showSuccess(message) {
        const alert = document.getElementById('successAlert');
        alert.textContent = message;
        alert.style.display = 'block';
    } 

    function hideAlerts() {
        document.getElementById('errorAlert').style.display = 'none';
        document.getElementById('successAlert').style.display = 'none';
    }
</script>
</body>
</html>